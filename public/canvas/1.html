<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,maximum-scale=1.0,minimum-scale=1.0,initial-scale=1.0,user-scalable=no">
    <script src="/libs/zepto.js"></script>
    <style>
    .scracherContainer {
        width: 586px;
        height: 272px;
        border: 1px solid red;
        position: relative;
    }
    .scracherContainer img {
        width: 100%;
        height: 100%;
    }
    #scracher {
        position: absolute;
        top: 0;
        width: 100%;
        height: 100%;
        left: 0;
        border: 1px solid #999;
    }
    </style>
    <title>刮刮乐</title>
</head>
<body>
    <div class="scracherContainer">
        <!-- 结果 可动态写入 -->
        <img src="/img/scratcher/background.png" alt="">
        <canvas id="scracher"></canvas>
    </div>
<script>
$(function () {
    var canvas = document.getElementById("scracher");
    var context = canvas.getContext("2d");
    var DPR = window.devicePixelRatio || 1;

    // 解决模糊问题
    canvas.width = canvas.width * DPR;
    canvas.height = canvas.height * DPR;

    // 写入刮层图片
    var image = new Image();
    image.onload = function () {
        // context.globalCompositeOperation = 'copy';
        context.drawImage(image, 0, 0, canvas.width, canvas.height);
        context.globalCompositeOperation = 'destination-out';
    }
    image.src = '/img/scratcher/foreground.png';


    // 设置scracherLine
    context.lineWidth = 30;
    context.lineCap = context.lineJoin = 'round';
    context.strokeStyle = 'rgba(0,0,0,1)';

    // 滑动事件
    context.canvas.onmousedown = function (e) {
        var x = e.pageX - this.offsetLeft;
        var y = e.pageY - this.offsetTop;

        context.moveTo(x, y);
        context.canvas.onmousemove = function (e) {
            var x = e.pageX - this.offsetLeft;
            var y = e.pageY - this.offsetTop;

            context.lineTo(x, y);
            context.stroke();
            // 检测滑动区域 clearRect
            if (scratcherProgress() < 60) {
                context.clearRect(0, 0, canvas.width, canvas.height);
                context.canvas.onmousemove = null;
                return;
            }
        }
    }
    context.canvas.onmouseup = function (e) {
        context.canvas.onmousemove = null;
    }
    function scratcherProgress () {//剩余百分比
        var pixels = context.getImageData(0, 0, canvas.width, canvas.height);
        var pdata = pixels.data;
        var stride = Math.pow(DPR, 2) * 32;
        var l = pdata.length;
        var total = (l / stride);

        for (i = count = 0; i < l; i += stride) {
            if (pdata[i] != 0) {
                count++;
            }
        }
        return count*100 / total;
    }
    // todo 支持手机 touch: true
    // 检测是否支持2d上下文
    // todo 图像模糊
})
</script>
</body>
</html>
